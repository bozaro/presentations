---
title: Очереди сообщений (2025)
---
<section class="slide" xmlns="http://www.w3.org/1999/html">
    <h2 class="shout">Зачем нужны очереди сообщений?</h2>
</section>

<section class="slide">
    <pre><code class="md,mark">- Часто какую-то крупную задачу нужно выполнить за один шаг. В БД часто используют транзакции.
- В случае использования нескольких БД нужны распределённые транзакции.
- Согласованность требует согласованного восстановления, что не всегда желательно или хотя бы возможно.
- Очереди позволяют "отложить" какое-то действие, чтобы оно после пришло в согласованное состояние.

- Работу с очередью можно сделать двумя способами: pub/sub (push), request/response (pull)
    </code></pre>
</section>

<section class="slide">
    <h2>Публикация/подписка (push)</h2>
    <p>Клиент подписывается на события. Брокер отправляет в клиента события по мере поступления.</p>
    <ul>
        <li>Ниже задержка</li>
        <li>Либо брокер подключается к клиенту, либо постоянное подключение клиента к брокеру</li>
    </ul>
</section>

<section class="slide">
    <h2>Опрос брокера (pull)</h2>
    <p>Клиент периодически проверяет состояние очереди.</p>
    <ul>
        <li>Высокая задержка</li>
        <li>Потребитель опрашивает брокера</li>
        <li>Потребители сами контролируют нагрузку</li>
        <li>Пакетная обработка</li>
    </ul>
</section>

<section class="slide">
    <h2>Опрос с ожиданием (pull + long pulling)</h2>
    <p>Клиент периодически проверяет состояние очереди. Если сообщений нет, то запрос ждёт их какое-то время.</p>
    <p>Позволяет получить плюсы pull и pysh подходов.</p>
</section>

<section class="slide">
    <h2 class="shout">Гарантии доставки сообщений</h2>
</section>

<section class="slide">
    <h2>Мир не идеален</h2>
    <ul>
        <li>Сеть ненадежна</li>
        <li>Программы ненадежны</li>
        <li>Оборудование ненадежно</li>
    </ul>
</section>

<section class="slide">
    <h2>Не больше одного раза (at most once)</h2>
    <ol>
        <li>Взять сообшение из очереди</li>
        <li>Удалить из очереди</li>
        <li>Отправить сообщение</li>
        <li>Забыть про него</li>
    </ol>
</section>

<section class="slide">
    <h2>Хотя бы один раз (at least once)</h2>
    <ol>
        <li>Взять сообшение из очереди</li>
        <li>Отправить сообщение</li>
        <li>Дождаться подтверждения о получении</li>
        <li>Удалить сообщение</li>
        <li>Если подтверждения не было, перейти к п. 1</li>
    </ol>
</section>

<section class="slide">
    <h2>Хотя бы один раз (at least once)</h2>
    <h3>На стороне брокера</h3>
    <ol>
        <li>Взять сообшение из очереди</li>
        <li>Отправить сообщение</li>
        <li>Дождаться подтверждения о получении</li>
        <li>Удалить сообщение</li>
        <li>Если подтверждения не было, перейти к п. 1</li>
    </ol>
</section>

<section class="slide">
    <h2>Хотя бы один раз (at least once)</h2>
    <h3>На стороне клиента</h3>
    <ul>
        <li>Присвоить сообщениям уникальный монотонно возрастающий номер</li>
        <li>Потребитель запрашивает сообщения с пропущенными номерами</li>
    </ul>
    <div class="important">
        <p>Потребитель должен быть ровно один.</p>
    </div>
</section>

<section class="slide">
    <h2>Ровно один раз (exactly once)</h2>
    <img src="once.png" style="width: 100%">
    <footer>
        <a href="https://x.com/mathiasverraes/status/632260618599403520">https://x.com/mathiasverraes/status/632260618599403520</a>
    </footer>
</section>

<section class="slide">
    <h2>Ровно один раз (exactly once)</h2>
    <h3>Задача двух генералов</h3>
    <ul class="compact" style="font-size: 90%">
        <li>Две армии, каждая руководимая своим генералом, готовятся к штурму города.</li>
        <li>Лагеря армий располагаются на двух холмах, разделённых долиной.</li>
        <li>Долина занята противником и любой из посыльных может быть перехвачен.</li>
        <li>Для успешного штурма генералы должны атаковать город одновременно.</li>
        <li>Если атакует одна армия, то она гарантированно уничтожается.</li>
        <li>Надо договорится о времени одновременной атаки.</li>
    </ul>
    <img src="two-generals.png" style="width: 450px; position: absolute; bottom: 50px; right: 50px; z-index: -1">
</section>

<section class="slide">
    <h2>Ровно один раз (exactly once)</h2>
    <h3>Попытка достижения нужного результата</h3>
    <ul>
        <li>Сообщения получают уникальный идентификатор</li>
        <li>Брокер отправляет сообщения пока не получит подтверждение</li>
        <li>Потребитель выполняет дедупликацию</li>
    </ul>
    <div class="important"><p>Ограничение: потребитель должен быть один.</p></div>
</section>

<section class="slide">
    <h2>Ровно один раз (exactly once)</h2>
    <p>Удалось гарантировать доставку, но гарантировать обработку ровно один раз все равно невозможно:</p>
    <ol>
        <li>Есть список полученных сообщений</li>
        <li>Берем сообщение</li>
        <li>Выполняем работу</li>
        <li>Удаляем сообщение</li>
    </ol>
    <p>Решает проблему идемпотентность выполняемой работы, но она не всегда достижима.</p>
</section>

<section class="slide">
    <h2 class="shout">Топологии очередей</h2>
</section>

<section class="slide">
    <h2>Один брокер</h2>
    <table>
        <thead>
        <tr>
            <th>Масштабируемость</th>
            <th>Доступность</th>
            <th>Надежность</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Отсутствует</td>
            <td>Низкая</td>
            <td>Низкая</td>
        </tr>
        </tbody>
    </table>
    <div style="text-align: center"><img src="single.png" style="width: 60%"></div>
</section>

<section class="slide">
    <h2>Несколько брокеров</h2>
    <table>
        <thead>
        <tr>
            <th>Масштабируемость</th>
            <th>Доступность</th>
            <th>Надежность</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Есть</td>
            <td>Высокая</td>
            <td>Средняя</td>
        </tr>
        </tbody>
    </table>
    <div style="text-align: center"><img src="many.png" style="width: 60%"></div>
</section>

<section class="slide">
    <h2>Несколько брокеров + дублирование</h2>
    <table>
        <thead>
        <tr>
            <th>Масштабируемость</th>
            <th>Доступность</th>
            <th>Надежность</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Есть</td>
            <td>Высокая</td>
            <td>Высокая</td>
        </tr>
        </tbody>
    </table>
    <div style="text-align: center"><img src="manyplus.png" style="width: 60%"></div>
    <p>Требуется идемпотентность или дедупликация</p>
</section>

<section class="slide">
    <h2>Репликация</h2>
    <table>
        <thead>
        <tr>
            <th>Масштабируемость</th>
            <th>Доступность</th>
            <th>Надежность</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Есть</td>
            <td>Высокая</td>
            <td>Высокая</td>
        </tr>
        </tbody>
    </table>
    <p>Проблему надёжности для схемы с несколькими брокерами можно решить через репликацию.</p>
</section>
